{% extends "window_base.html" %}
{% load static %}

{% block title %}Get availability predictions{% endblock %}
{% block extra-css %}
    <link rel="stylesheet" type="text/css" href="{% static 'divassist_web/home.css' %}" />
{% endblock %}

{% block content %}
    <head>
        <style>
        #map {
            height: 400px;
            width: 100%;
        }
        </style>
    </head>
    <body>
        <h3>Availability Prediction</h3>
        <div id="map"></div>
        <script>
        function initMap() {
            var chicago = {lat: 41.85, lng: -87.65};
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: chicago
            });
            // add heatmap / station markers
            var circle ={
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: 'red',
                fillOpacity: .4,
                scale: 4.5,
                strokeColor: 'white',
                strokeWeight: 1
            };

            // define info window
            var infoStr = "**placeholder**"
            infoWindow = new google.maps.InfoWindow({
                content: infoStr
            });

            heatmapData = []
            stationMarkers = []
            {% for prediction in predictions %}
            // add heatmap data
            heatmapData.push({
                location: new google.maps.LatLng({{ prediction.station.station_long }}, {{ prediction.station.station_lat }}),
                weight: {{ prediction.bikes_available }}
            });            
            // add marker
            var stationMarker = new google.maps.Marker({
                position: {lat: {{ prediction.station.station_long }}, lng: {{ prediction.station.station_lat }}},
                title: "{{ prediction.station.station_name }}".replace("&amp;", "&"),
                icon: circle,
                map: map,
                html: "{{ prediction.station.station_name }}<br>Predicted availability: {{ prediction.bikes_available }} bikes"
            });
            // add info window click event
            stationMarker.addListener('click', function() {
                infoWindow.setContent(this.html);
                infoWindow.open(map, this);
            });
            stationMarkers.push(stationMarker);
            {% endfor %}

            var heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: map,
                maxIntensity: 8,
                radius: 85
            });
            heatmap.setMap(map);

            // get user's location and center
            var geoLocationSuccess = function(location) {
                var userLatLong = {lat: location.coords.latitude, lng: location.coords.longitude}
                map.setCenter(userLatLong);
                map.setZoom(16);
                var marker = new google.maps.Marker({
                    position: userLatLong,
                    map: map,
                });
            }
            var geoLocationFailure = function(error) {
                // TODO: what to do here?
                alert("Geolocation failed.");
            }
            navigator.geolocation.getCurrentPosition(geoLocationSuccess, geoLocationFailure);
        }
        </script>
        <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&libraries=visualization&callback=initMap">
        </script>
    </body>
{% endblock %}